# 前言

许多年来，Linux都是嵌入式计算的支柱。然而，能完整覆盖该主题的书非常少，本书旨在填补这一空白。“嵌入式Linux”并没有一个明确的定义，它可以用来描述从恒温器到Wi-Fi路由器亦或者工业控制单元等各种设备中的操作系统。然而，它们都是基于相同的基础开源软件构建的。这些技术就是我准备在本书中介绍的，基于我工程师的经验与我为培训课程准备的材料。

科技的发展不会止步。以嵌入式计算为基础的行业与主流计算一样会受到摩尔定律的影响。这意味着从本书第一版出版以来许多事情已经发生了翻天覆地的变化。本书第三版经过了全面修订，并使用了主要开源组件的最新版本，包括Linux5.4、Yoctp Project 3.1 Dunfell与Buildroot2020.02LTS。除了AutoTool，本书现在还涵盖里CMake，这是一种现代构建系统，今年来被广泛使用。

本书涵盖的主题大致安装您在实际项目中所遇到的顺序排列。前八章与项目的早期阶段有关，涵盖了工具链的选择、bootloader和内核等相关知识。我以Buildroot和Yocto Project为例介绍了嵌入式构建系统的概念。这一部分以对Yocto Project的新的深入覆盖结束。

第二部分，从第9章到15章着眼于正式开发之前需要做的各种设计决策。它涵盖文件系统、软件更新、设备驱动程序、init程序和电源管理等主题。第12章演示了使用原型版进行快速开发的各种技术，包括如何阅读原理图、接口、以及使用逻辑分析仪对信号进行故障排除。第14章将深入介绍Buildroot，您将在其中学习如何使用BusyBox runit将软件划分为单独的服务。

第三部分，16、17、18三章将会在项目的实施阶段为您提供帮助。我们从Python打包和依赖管理开始，这是一个随着机器学习应用程序风靡全球而越来越重要的话题。接下来，我们将讨论各种形式的进程间通信与多线程编程。本节最后，对于Linux的内存管理问题进行了深入讨论，并且演示了如何使用各种可用的工具检测内存使用情况与内存泄漏。

第四部分，包括19和20章，向您展示了如何有效的使用Linux提供的许多调试与分析工具来检测问题或者识别瓶颈。第19章介绍了如何配置Visual Studio COde以进行远程调试。第20章现在涵盖了BPF，这是一种在Linux内核中启用高级编程跟踪的新技术。最后一章汇合了一些关于在实时应用程序中使用Linux的内容。


本书每章介绍了嵌入式Linux的一个主要领域。它描述了背景，以便您可以了解一般原则，它还包括了详细的工作示例来帮助说明。你可以把它当一本理论书，也可以把它当做一本示例书。如果你能理解理论并能在现实生活中尝试，那就更好了。

## 本书适合哪些人
本书是为对嵌入式计算和 Linux 感兴趣并希望将知识扩展到该主题的各个分支的开发人员编写的。在撰写本书时，我假定你对 Linux 命令行有基本的了解，并且在编程示例中，我假定你具备C和Python语言的应用知识。有几章重点介绍嵌入式目标板中的硬件，因此，熟悉硬件和硬件接口在这些情况下将是一个明确的优势。

## 本书涉及范围
第一章，出发。通过描述嵌入式Linux生态系统和您在开始项目时可选的设置代入场景。
第二章，工具链学习。描述工具链的组件，并向您展示如何为目标板交叉编译代码创建工具链。本章描述了如何获取工具链，并且提供了如何从源代码构建工具链的详细信息。
第三章，关于Bootloader。解释里BootLoader在将Linux加载入内存中的作用，并且以U-Boot作为例子。本章还介绍了设备树，这是一种几乎所有嵌入式Linux系统使用的对硬件细节进行编码的机制。
第四章，配置并构建内核。介绍了如何为嵌入式系统选择一个Linux内核并给予设备的硬件情况对其进行配置。本章也涉及到如何移植Linux到一个新的硬件。
第五章，构建根文件系统。通过如何配置根文件系统的步骤说明，介绍了嵌入式Linux实现的用户空间部分背后的思想。
第六章，构建系统选择。涉及两个常见的嵌入式Linux构建系统，Buildroot和Yocto Project，它们可以自动化的执行之前四章的步骤。
第七章，基于Yocto开发。演示了如何在现有BSP层之上构建系统镜像，使用Yocto的可扩展SDK开发板载软件包，以及使用运行时包管理完成你自己的嵌入式Linux发行版。
第八章，Yocto深入探讨。Yocto的构建工作流与架构之旅。包括对Yocto独特的多层方法的解释。它还通过实际配方文件的示例分解了BitBake语法和语义的基础知识。
第九章，存储策略创建。讨论里闪存管理带来的挑战。包括了原始闪存和嵌入式MMC（eMMC）封装。本章描述了适用于每种技术的文件系统。
第十章，现场更新软件，讨论了设备部署后的各种软件更新方法。包括完全托管的无线（OTA）更新。讨论的关键是可靠性和安全性。
第十一章，连接设备驱动。描述了内核设备驱动程序如何通过实现一个简单的驱动程序与硬件交互。它描述了从用户空间调用设备驱动程序的各种方式。
第十二章，基于原型版开发。演示了如何使用为BeagleBone Black预构建的Debian镜像以及外围分线板快速制作硬件和软件原型。你将学习如何阅读数据表、连接电路板、多路复用设备树绑定以及分析SPI信号。
第十三章，启动 - init程序。解释了第一个用户空间程序--init如何启动系统的其他部分。本章介绍了init的三个版本，每个版本都适用于不同的嵌入式Linux系统，从简单的的BusyBox init到System V init，以及当前最先进的方法systemd。
第十四章，从BusyBox init开始。向您展示怎么使用Buildroot将系统划分为单独的BusyBox runit服务，每个服务都有自己独立的进程监控和日志记录，就像systemd一样。
第十五章，电源管理。考虑了可以调整Linux以降低功耗的各种方式，包括动态频率与电压缩放、选择更深的空闲状态以及系统挂起。目的是使设备在电池充电后运行时间更长，运行温度更低。
第十六章，Python打包。描述了在Python部署时可以捆绑的一些可选项，以及该如何对其进行选择。本章涵盖了pip、虚拟环境、conda和Docker。
第十七章，进程与线程的学习。从应用程序员的角度描述了嵌入式系统。本章着眼于进程和线程、进程间通信和调度策略。
第十八章，内存管理。本章介绍了虚拟内存背后的思想以及地址空间如何划分为内存映射。本章还介绍了如何测量内存的使用情况以及内存泄漏的检测。
第十九章，使用GDB调试。向您展示如何使用 GNU 调试器 GDB，GDB与调试代理gdbserver一起调试在目标设备上远程运行的应用程序。它继续展示了如何扩展这个模型来调试内核代码，使用KGDB调试内核桩。
第二十章，分析与追踪。本章涵盖可用于测量系统性能的技术从整个系统profile文件开始，然后集中在瓶颈导致性能不佳的特定区域。它还描述了如何使用Valgrind检查应用程序使用线程同步的正确性和内存分配。
第二十一章，实时编程。提供了Linux实时编程的详细指南。包括内核的配置与PREEMPT_RT实时内核补丁。用于测量内核延迟并展示内核配置效果的内核追踪工具Ftrace。

## 为了充分利用本书
本书所使用的软件是完全开源。在几乎所有情况下，我都使用里撰写本文时可用的最新稳定版本。虽然我已尝试以非特定版本的方式描述主要功能，但不可避免的是，某些示例需要进行调整才能与更新的软件一起使用。
| 本书涉及的硬件、软件 | 系统要求 | 
| ----------------- | ------- |
| BeagleBone Black | 不适用 |
| 树莓派4 | 不适用 |
| QEMU(32位 Arm) | Linux(任意) |
| Yocto Project 3.1（Dunfell) | 兼容的Linux发行版* |
| Buildroot 2020.02 LTS | Linux(任意) |
| Crosstool-NG 1.24.0 | Linux(任意) |
| U-Boot v2021.01 | Linux(任意) |
| Linux 内核 5.4 | Linux(任意) |
_*请参阅Yocto Project快速构建指南的兼容的Linux发行版部分，网址为https://docs.yoctoproject.org/current/brief-yoctoprojectqs/brief-yoctoprojectqs.html(https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html#compatible-linux-distribution)_
嵌入式开发涉及两个系统：用于开发程序的主机和运行程序的目标系统。对于主机系统，我使用的是Ubuntu 20.04 LTS，但大多数 Linux 发行版只需稍作修改即可使用。您可能决定在虚拟机中将 Linux 作为客机运行，但您应该意识到某些任务（例如使用Yocto项目构建发行版）要求很高，最好在 Linux 的本机安装上运行。
我选择了三个示例目标：QEMU 模拟器、BeagleBone Black和Raspberry Pi 4。使用QEMU意味着您可以尝试大部分示例，而无需投资任何额外的硬件。另一方面，如果你有真正的硬件，有些事情会更好，为此，我选择BeagleBone Black，因为它不贵，应用广泛，而且有很好的社区支持。Raspberry Pi 4 因其内置 Wi-Fi 和蓝牙而在第三版中被添加。当然，您不仅限于这三个目标。本书背后的想法是为您提供问题的通用解决方案，以便您可以将它们应用于广泛的目标板。
## 下载示例代码
你可以通过GitHub下载本书的示例代码，地址在https://github.com/PacktPublishing/Mastering-Embedded-Linux-Programming-Third-Edition。如果代码有更新，它将在现有的 GitHub 存储库中更新。 我们还提供丰富的书籍和视频目录中的其他代码包，网址为https://github.com/PacktPublishing/。看一下吧！
## 下载彩色图像
我们还提供了一个PDF文件，其中包含本书中使用的屏幕截图/图表的彩色图像。你可以在这里下载：http://www.packtpub.com/sites/default/files/downloads/9781789530384_ColorImages.pdf