# 开始
你即将开始进行下一个项目，这次它将运行在Linux。在你把手指放在键盘之前，你应该考虑什么？让我们先从高层次了解嵌入式Linux，看看它为何受欢迎，开源许可证的含义是什么，以及运行Linux需要什么样的硬件。
1999年左右，Linux首次成为嵌入式设备的可行选择。当时，Axis(https://www.axis.com )发布了他们的第一款网络摄像头，同时TiVo(https://bussiness.tivo.com )发布了他们的第一台数字视频录像机(DVR)。自1999年以来，Linux变得越来越流行，以至于它是当前诸多类别产品的首选操作系统。2021年，有超过20亿台设备运行Linux操纵系统。这其中包括大量运行Android（使用Linux内核）的智能手机，以及数亿个机顶盒，智能电视与Wi-Fi路由器，更不用说体积较小的各种设备，如车辆诊断仪、称重设备、工业设备与医疗监控设备。

在这一章，我们将会覆盖一下内容：
- Linux的选择
- 何时不该使用Linux
- 与玩家见面
- 贯穿项目生命周期
- 开源导航
- 选择嵌入式Linux的硬件
- 获取适合于本书的硬件
- 配置开发环境

## Linux的选择
为什么Linux如此普遍被使用？以及为什么像TV这么简单的东西也需要运行完整的Linux来在屏幕上显示流媒体视频。
最简单的原因就是摩尔定律：Intel的联合创始人Gordon Moore在1965年发现，芯片上的晶体管密度每两年翻一番。这适用于我们在日常生活中设计和使用的设备，就像适用于台式机、笔记本电脑和服务器一样。大多数嵌入式设备的核心是一个高度集成的芯片，它包含一个或多个处理器内核以及与主存储器、大容量存储器和多种类型外围设备的接口。这被称为片上系统或SoC，并且SoC的复杂性根据摩尔定律不断增加。典型的SoC具有长达数千页的技术参考手册。您的电视不只是像过去的旧模拟电视机那样简单地显示视频流。
视频流是数字的，有可能被加密了，并且需要处理才能创建图像。您的电视已经（或者即将）连接到互联网。它可以接受来自智能手机、平板电脑和家庭媒体服务器的内容。它可以（或即将）用于玩游戏等。您需要一个完整的操作系统来管理这种程度的复杂性。
以下是推动采用Linux的一些要点：
- Linux具有必要的功能。它具有良好的调度器、良好的网络堆栈、支持USB、Wi-Fi、蓝牙、多种存储介质、良好的多媒体设备支持等。它符合所有条件。
- Linux已经移植到范围广泛的处理器架构中，包括一些在SoC设计中非常厂家的架构--Arm、MIPS、x86和PowerPC。
- Linux是开源的，因此您可以自由获取源代码并对其进行修改以满足您的需要。您或者为您工作的人可以为您的特定SoC板或设备创建板级支持包。您可以添加主线代码中可能缺少的协议、功能和技术。您可以删除不需要的功能已减少内存或者存储要求。Linux是灵活的。
- Linux有一个活跃的社区；尤其是Linux内核，非常活跃。内核每8到10周发布一次新版本，每个版本包含1000多名开发人员的代码。活跃的社区意味着Linux是最新的，并支持当前的硬件、协议和标准。
- 开源许可证保证您可以获取源代码。没有供应商搭售。

因为这些原因，Linux对于复杂设备的理想选择。但这里有几点需要注意的地方。复杂性使人难以理解。加上快速发展的开发过程和开源的去中心化结构，你必须努力学习如何使用它，并在它发生变化时继续重新学习。我希望这本书能在这个过程中有所帮助。

## 什么时候不选择Linux
Linux是否符合你的项目？Linux在那些已经被证明了问题复杂性的地方工作良好。尤其适合于需要连通性、健壮性和复杂用户界面的情况下。然而，它不能解决所有问题，因此在您加入之前，需要考虑以下几点：
- 你的硬件够用吗？相比较VxWorks或者QNX等传统实时操作系统（RTOS），Linux需要消耗更多的资源。它至少需要一个32位的处理器与更多内存。我将在有关典型硬件要求的部分进行更详细的介绍。
- 你有合适的技能栈吗？项目的早期部分，电路板的bring-up需要对Linux有详细的了解并将其与您的硬件联系起来。同样，在调试与调整您的应用程序时，您需要能明白结果。如果你不具备内行的技能，可能需要将这部分工作外包。当然，本书会对此有帮助。
- 你的系统是实时的吗？只要你注意一些细节，Linux就可以处理许多实时操作，我会在第21章实时编程中详细介绍。
- 你的代码是否需要监管部门的批准（医疗、汽车、航空航天等）？法规验证和验证的负担可能意味着另一个系统是更好的选择。即使你确实在这些环境选择Linux，从为现有产品（例如你正在构建的产品）提供Linux的公司购买商业发行版也可能是有意义的。
  
你要仔细考虑这些要点。一个可能有用指标是去寻找运行Linux的类似产品，看看他们是如何做到的；遵循最佳实践。

## 与玩家见面 
开源工具从何而来？谁写的这些软件？特别是，这与嵌入式开发的关键组件（工具链、bootloader、内核、根文件系统中的基本实用程序）有何关系？
主要的参与者如下：
- **开源社区**:毕竟，这是生成你即将使用软件的引擎。社区是开发人员的松散联盟，其中许多人以某种方式获得资助，可能来自非盈利组织、学术机构或者商业公司。他们共同努力，以推进各种项目的目标。它们有很多，大小也不一样。我们将在本书的其余部分中使用的一些项目包括Linux本身、U-Boot、BusyBox、Buildroot、Yocto Project与以及GNU保护伞下的许多项目。
- **CPU架构师**：这些是设计我们所使用CPU的组织。这里最重要的是Arm/Linaro（Arm Cortex-A）、Intel（x86和x86_64），SiFive（RISC-V）和IBM（PoverPC）。他们实现或者至少影响对基本CPU架构的支持。
- **SoC供应商（Broadcom、Intel、Microchip、NXP、Qualcomm、TI等）**：他们从CPU架构师那里获取内核和工具链，并对其进行修改以支持他们的芯片。他们还创建参考板：下一级用于创建开发板和工作产品的设计。
- **电路板供应商和OEM**：这些人从SoC供应商那里获取参考设计并将它构建到特定产品中，例如机顶盒或者相机，或者创建更通用的开发板，例如Advantech和Kontron。一个重要的类别是便宜的开发板，例如BeagleBoard/BeagleBone和Raspberry Pi ，它们已经创建了自己的软件和硬件附加组件生态系统。
- **商业Linux供应商**：Siemens(Mentor)、Timesys和Wind River等公司提供商业Linux发行版，这些发行版以及经过多个行业（医疗、汽车、航空航天等）的严格监管验证与认证。
  
这是一个链条，你的项目往往在最后，这意味着你不能自由选择组件，你不能简单的从https://www.kernel.org/ 获取最新的内核，除非在极少数情况下，这是因为它往往不能支持你所使用的芯片与板。

这是嵌入式开发一直存在的问题。理想情况下，链中的每一个环节开发人员都会将他们的更改推送到上游，但他们没有这么做。数千个未合并补丁的内核并不罕见。此外，SoC供应商往往只会为其最新的芯片积极开发开源组件，这意味着对任何超过几年的芯片支持将被冻结并且不会收到任何更新。
结果是，大多数嵌入式设计都基于旧版本的软件。他们不会收到更新版本中的安全修复、性能增强或功能。Heartbleed（OpenSSL库中的错误）和ShellSlock（bash shell中的错误）等问题未得到修复，我将在本章稍后的安全主题中详细讨论这一点。
你能为这个做什么？首先，询问你的供应商(NXP、德州仪器和Xilink等)：他们的更新政策是什么，他们多久修改一次内核版本，之前的版本是什么，他们在上游合并更改的政策是什么？一些供应商正在以这种方式获得长足进步，你应该喜欢他们的筹码。
其次，你可以采取措施让自己更加自给自足。第一部分的章节更详细的解释了依赖关系，并向你展示了您可以在哪些方面提供帮助。不要只会使用SoC或者板卡供应商提供给你的包，盲目使用而不考虑替代方案。

## 贯穿项目生命周期
本书分为四个部分，反映了项目的各个阶段。这些阶段不一定是连续的。通常，它们会重叠，您需要跳回去重新审视之前完成的事情。然而，它们代表了开发人员在项目进展中所关注的问题。
- _嵌入式Linux的组成（1到8章）_ 将会帮助你设置开发环境并为后期阶段创建工作平台。它们通常称为电路板的**bring-up**阶段。
- _系统架构与设计决策（9到15章）_ 将帮助你了解你必须做出的设计决策，设计程序与数据的存储、如何在内核设备驱动程序与应用程序之间分配工作以及如何初始化系统。
- _编写嵌入式应用程序（16到18章）_ 展示了如何打包和部署Python程序，有效利用Linux进程与线程模型，以及如何在资源受限的情况下管理内存。
- _调试与性能优化（19到21章）_ 描述了如何在应用程序与内核中跟踪、剖析和调试代码，最后一章介绍了如何在需要时设计实时程序。
  
现在，让我们关注构成本书第一部分的嵌入式 Linux 的四个基本元素。

## 嵌入式Linux的四个组成元素
每个项目都从获取、定制和部署这四个元素开始：工具链、bootloader、内核和根文件系统。这是本书第一部分的主题：
- **工具链**：为你的目标设备创建代码需要的编译器与其他工具
- **Bootloader**：初始化板子与加载内核镜像的程序
- **内核**：系统的核心，管理系统资源并与硬件交互
- **根文件系统**：包含了内核完成初始化后运行的库和程序

当然，这里还有一个并未提及的第五元素。那就是特定于您的嵌入式应用的程序集合，使设备可以做任何它应该做的事，无论是称重杂货、放映电影、控制机器人还是驾驶无人汽车。
通常，当你购买SoC或电路板时，你会获得部分或者全部这些元素作为一个包。但是，由于前一段提到的原因，它们可能不是你的最佳选择。我将在前八章中为你提供做出正确选择的背景知识，并且将向你介绍两个可以自动执行整个过程的工具：Buildroot和Yocto Project。

## 开源导航
嵌入式Linux的组件都是开源的，所以我们需要考虑一下这意味着什么，为什么开源是这样运行的，以及这将如何影响到你使用它们创建通常专用的设备。

### 许可证
当讨论到开源的时候，免费（free）这个词语经常被使用。通常刚了解这个主题的人会意味着它是无需付费的，而开源软件许可确实保证你可以免费使用该软件开发和部署系统。然而，这里更重要的意义是自由（free），因为你可以自由的获取源代码，以任何你以为合适的方式进行修改，并在其他系统中重新部署它。这些许可证赋予你这些权利。将其余免费软件许可证比较，后者运行你免费复制二进制文件但不提供源码，或者其他许可证允许你在某些情况下免费使用该软件，例如仅供个人使用不允许商用。这些都不是开源的。
为了帮助你理解开源许可证的含义，我将提供以下解读，但我要澄清我是工程师而不是律师。以下是我对许可证及其解释方式的理解。
开源许可证大致分为两类：_copyleft_ 许可证如**GNU通用公共许可证（GNU General Public License，GPL)**，和宽松许可证如**BSD**和**MIT**许可证。
从本质上讲，宽松许可证说，只要您不以任何方式修改许可证条款，您就可以修改源代码并将其用于您自己选择的系统中。换句话说，有了这个限定，你就可以随心所欲地使用它，包括将它构建到可能的专有系统中。
GPL许可证类似，但有条款强制您将获取和修改软件的权利传递给您的最终用户。换句话说，您共享您的源代码。一种选择是通过将其放在公共服务器上使其完全公开。另一种方法是通过书面报价的方式仅向您的最终用户提供代码，以便在请求时提供代码。GPL进一步说明您不能将GPL代码合并到专有程序中。任何这样做的尝试都会使GPL适用于整体。换句话说，您不能在一个程序中结合GPL和专有代码。除了Linux内核之外，GNU Compiler Collection和GNU Debugger以及许多其他与GNU项目相关的免费工具都属于GPL的范畴。
那么，库呢？如果它们是在GPL许可下的，那与它们链接的任何程序也将成为GPL。但是大多数库都是根据GNU宽松通用公共许可证（**GNU Lesser General Public License，LGPL**)获取许可的。如果是这种情况，你可以在专用程序与它们链接。

|**重要提醒** ：前面的所有描述都与GPL v2和LGPL v2.1直接相关。我需要说明最新的版本是GPL v3和LGPL v3 的最新版本。这些都是有争议的，我承认我并不完全理解其中的含义。但是，其意图是确保任何系统中的GPL v3和 LGPL v3组件都可以被最终用户替换，这是本着开源软件人人共享的精神。|
|--------|

GPL v3和LGPL v3也有它们的问题。它们在安全上存在问题。如果设备的所有者可以访问系统代码，那么不受欢迎的入侵者也可能如此。通常防御措施是让内核映像由供应商等权威机构签名，这样就不可能进行未经授权的更新。这是否侵犯了我修改设备的权利？大家还没有达成一致的意见。

|**重要提醒** ：TiVo机顶盒是这场辩论的重要组成部分。它使用 Linux 内核，该内核在GPL v2下获得许可。 TiVo 已经发布了他们的内核版本的源代码，因此符合许可证。TiVo还有一个引导加载程序，它只会加载由他们签名的内核二进制文件。因此，您可以为TiVo盒构建修改后的内核，但不能将其加载到硬件上。自由软件基金会 (Free Software Foundation ，FSF) 认为这不符合开源软件的精神，并将此过程称为Tivoization。GPL v3和LGPL v3的编写是为了明确防止这种情况发生。一些项目，尤其是Linux内核，一直不愿意采用GPL第3版许可证，因为它们会对设备制造商施加限制。|
|----------|

## 为嵌入式Linux选择硬件
如果你正在为嵌入式Linux项目设计或者选择硬件，你要注意什么?
首先，你要注意内个支持的CPU架构--当然除非你打算自己添加一个新的架构！查看Linux5.4的代码，总共有25种体系结构，每种体系结构都由arch/目录下的一个子目录表示。它们都是32位或者64位架构，大多数带有MMU，但有些没有。嵌入式设备最常见的是Arm、MIPS、PowerPC和x86，每种都有32位和64位版本，也都有内存管理单元（memory management units，MMUs）。
本书的大多数内容都是针对此类处理器编写的。还要另一组没有MMU的，运行的是Linux的一个子集，被称作微控制器Linux或者uClinux。这些处理器架构包括ARC（Argonaut RISC Core）,Blackfin, MicroBlaze,和Nios。我会不时的提到uClinux，但是不会展开介绍，因为那是另一个专门的话题。
其次，你需要合理大小的RAM。16M作为最小值是比较合理的，尽管在一半的大小上运行Linux是可能的。如果你准备好优化系统的每一个部分，甚至可以用4M运行Linux。它甚至有可能更小，但是小到一定程度它就不再是Linux了。
第三，需要非易失性存储，通常是闪存。8M大小以及足够用于网络摄像头或者基础路由器等简单的设备。和RAM一样，如果你真的愿意，你可以再很小的存储上运行可用的Linux系统，但是存储越小就越难。Linux 广泛支持闪存设备，包括原始NOR和NAND闪存芯片，以及SD卡、eMMC芯片、USB闪存等形式的托管闪存。
第四，串口是非常有用的，最好是基于UART的串口。它不必安装在生产电路板上，但可以使电路板启动、调试和开发变得更加容易。
第五，从头开始的时候需要一些加载软件的方法。因此，许多微控制器板都配置了联合测试行动组（**Joint Test Action Group，JTAG**）接口。现代SoC还可以直接从可移动媒体（尤其是SD卡和micro SD）或者串行接口（如UART或 USB）加载引导代码。
除了这些基础知识，还要一些接口可以连接你的设备完成其工作所需的特点硬件位。主线Linux带有用于数千种不同设备的开源驱动程序，并且有来自SoC制造商和可能包含在设计中的第三方芯片OEM的驱动程序（质量参差不齐），你可以参考我对一些厂商能力与承诺的看法。作为嵌入式设备的开发人员，你会发现你话费了大量时间来评估与调整第三方代码（如果有的话），或者没有这些你需要自行与制造商联系。最终，你需要自己为设备特有的接口编写代码提供支持或者将任务交给别人。

## 获取适合本书的硬件
本书中的示例旨在通用，但为了使它们相关且易于理解，我不得不选择特定的硬件。我选择了三个示例设备：树莓派4、BeagleBone Black和QEMU。第一款是迄今为止市场上最受欢迎的基于Arm的单板计算机。第二种是广泛可用且廉价的开发板，可用于重要的嵌入式硬件。第三个是虚拟机仿真器，可用于创建一系列典型的嵌入式硬件系统。专门使用QEMU很诱人，但是，像所有仿真一样，它与真实的东西不太一样。使用树莓派4和BeagleBone Black，您可以满意地与真实硬件交互并看到真实的LED闪烁。虽然BeagleBone Black现在已有数年历史，但它仍然是开源硬件（与树莓派不同）。 这意味着任何人都可以免费获得电路板设计材料，以将BeagleBone Black或衍生产品构建到他们的产品中。
无论如何，我鼓励您使用这三个平台中的任何一个，或者您可能必须使用的任何嵌入式硬件，尽可能多地尝试示例。

### 树莓派4
截止到本文撰写时，树莓派4B是树莓派基金会生产的旗舰级支持双视频输出微型计算机，他们的网站是https://raspberrypi.org/。 树莓派4的技术规格包含如下内容：
- Broadcom BCM2711 1.5GHz四核Cortex-A72（ARM®V8)64位SOC
- 2G、4G或8G大小的DDR4 RAM
- 2.4GHz和5.0GHz 802.11ac无线，蓝牙5.0，BLE
- 一个可用于调试和开发的串行接口
- 一个可用作启动设备的microSD插槽
- 一个用于供电的USB-C接口
- 2个全尺寸USB 3.0和2个全尺寸USB 2.0主机接口
- 一个千兆以太网端口
- 两个可用于视频和音频输出的Micro-HDMI接口

此外，其还有一个40针的扩展排针给各种各样的子板，一般称为扩展板（**Hardware Attached on Top，HATs**），可以让你利用板子做很多不同的事。但是，本书的示例不需要任何扩展板。与之替代的是，你可以利用树莓派4中的内置Wi-Fi和蓝牙（BeagleBone Black是没有的）。
除了板子，你还需要以下东西：
- 一个5V的USB-C电源，需要能提供3A或者更多的电流
- 带有3.3V逻辑电平的USB-TTL串行线，比如Adafruit 954
- 一个MicroSD卡和通过你的开发PC或者笔记本写入的手段，因为需要用它将软件加载到板子
- 以太网线以及可以连接的路由器，因为一些例子需要联网

接下来是BeagleBone Black

### BeagleBone Black
Beaglebone和后来的Beaglebone Black都是CircuitCo LLC针对小型卡片型开发板做的开源设计。主要的信息在https://beagleboard.org/ 获得。硬件规格的主要特点如下：
- 一个德州仪器的AM335x 1GHz Arm® Cortex-A8 Sitara SoC
- 512M的DDR3 RAM
- 2G、4G、8G可选的EMMC板载闪存
- 一个可以用来调试和开发的串口
- 一个可用作启动设备的microSD卡槽
- 一个Mini-USB OTG客户端/主机接口，并且可以用其为板子供电
- 一个全尺寸USB2.0主机端口
- 一个10/100M 以太网端口
- 一个用以音视频输出的HDMI端口

此外，还要两个46针的扩展排针，包括大量的子板帮助你使用板子做很多事。但是你无需为本书的例子安装任何子板。
除了板子本身，你还需要一下内容：
- 一个Mini-USB 转USB-A的线（由板子提供）
- 一个可以连接板子上6针3.3V TTL级信号的串行线。Beagleboard网站上有兼容电缆的链接。
- 一个microSD卡和从开发PC或者笔记本写入的方法，用以将软件加载到板子上
- 一个以太网线和可连接的路由器，因为有些例子需要连网
- 可以驱动超过1A电流的5V电源

除上述内容外，第12章，基于原型板开发，还需要一下：
- parkFun GPS-15193型号原型板
- Saleeae Logic 8逻辑分析仪。 该设备将用于探测Beaglebone Black和Neo-M9N之间的SPI通信

## QEMU
QEMU是一个机器的模拟器，它具有多种不同的实现种类，每种实现种类都可以模拟一种处理器体系结构以及可以使用该体系结构的许多板子。例如，我们有以下实现种类：
- qemu-system-arm: 32-bit Arm
- qemu-system-mips: MIPS
- qemu-system-ppc: PowerPC
- qemu-system-x86: x86 and x86_64

对于每种体系结构，QEMU都会模拟一系列硬件，你可以使用-Machine帮助选项看到它们。每台机器都会模仿通常在该板上找到的大多数硬件。有可以将硬件链接到本地资源的选项，例如使用本地文件进行模拟磁盘驱动器。
这是一个具体示例：
```shell
$ qemu-system-arm -machine vexpress-a9 -m 256M -drive file=rootfs.ext4,sd -net nic use -kernel zImage -dtb vexpress- v2p-ca9.dtb -append "connsole=ttyAMA0,115200 root=/dev/mmcblk0" -serial stdio -net nic,model=lan9118 -net tap,ifname=tap0
```

在上述命令行使用的选项如下所示：
- -machine vexpress-a9：使用Cortex A-9处理器创建一个Arm Versatile Express开发板的模拟器
- -m 256M：使用256M的RAM
- -drive file=rootfs.ext4,sd：将SD接口连接到本地的rootfs.exts（其中包含了文件系统镜像）
- -kernel zImage：通过本地文件zImage加载Linux内核
- -dtb vexpress-v2p- ca9.dtb：通过本地文件vexpress-v2p-ca9.dtb加载设备树
- -append "..."：添加这个字符串作为内核命令行
- -serial stdio：将串口端口连接到启动QEMU的终端，通常这样你就可以通过串口控制台登录到模拟器
- -net nic，model=lan9118：创建一个网络接口
- -net tap,ifname=tap0：将网络接口连接到虚拟网卡，tap0

为了配置主机侧的网络，你需要来自用户模式Linux（**User Mode Linux，UML**）项目的**tunctl**命令行。在Debian和Ubuntu系统上，这个包名字叫uml-utilites：
```shell
$ sudo tunctl -u $(whoami) -t tap0
```
这将创建一个名为tap0的网络接口，该接口连接到模拟QEMU机器的网络控制器。你可以按照与其他接口完全相同的方法配置tap0。
所有的这些选项设置都会在后续章节详细介绍。我会在大部分的示例中使用Versatile Express，但是换到别的机器或者架构应该是容易的。

### 配置你的开发环境
我只使用开源软件，包括开发工具和目标操作系统与应用程序。我假设你会在你的假发系统上使用Linux。我使用Ubuntu20.04LTS测试了所有主机命令，是因此对特定版本有轻微的区别对待，但是任何现代Linux都应该能工作良好。

## 总结
遵循摩尔定律的指引，嵌入式硬件将变得越来越复杂。而Linux具有高效利用硬件的能力与灵活性。我们将一起学习如何利用它，以便我们能创建令用户满意的强大产品。本书将从嵌入式Linux的4个要素开始，带你了解嵌入式项目生命周期的五个阶段。
嵌入式平台的多样性与快速的开发节奏导致了软件池的隔绝。在很多时候，你将比较依赖SoC或者电路供应商提供的Linux内核，或许还依赖于工具链。有一些SoC的供应商以及非常善于将自己的改动推回上游，这让这些变更的维护变得更容易。尽管如此，为你的嵌入式项目选择合适的硬件仍然是一项充满风险的工作。在嵌入式Linux生态系统上构建产品时，开源许可证规范也是你需要注意的另一个问题。
本章向你介绍了本书涉及到的硬件和一些软件（QEMU）。之后，我们将研究一些可以帮助您创建和维护设备软件的强大工具。我们涵盖了Buildroot并且深入研究了Yocto项目。在描述这些构建系统之前，我会介绍嵌入式Linux的4个要素，您可以将其用于所有嵌入式项目，无论它是如何创建的。
下一章是这些中的第一个，工具链。你需要使用工具链来为你的目标平台编译代码。